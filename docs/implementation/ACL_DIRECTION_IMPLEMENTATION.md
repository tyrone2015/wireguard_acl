# WireGuard ACL 方向控制功能实现总结

## 功能概述
成功为WireGuard ACL管理系统添加了**方向控制**功能，用户现在可以为防火墙规则指定流量方向，包括：
- **入口方向 (inbound)**：控制从外部网络进入WireGuard网络的流量
- **出口方向 (outbound)**：控制从WireGuard网络出去的流量
- **双向 (both)**：同时控制入口和出口流量

## 实现方案

### 1. 数据库模型修改
- 为ACL表添加`direction`字段，类型为TEXT，默认值为`'both'`
- 字段为NOT NULL，确保所有规则都有明确的方向
- 通过数据库迁移脚本为现有数据添加字段并设置默认值

### 2. 后端API修改
- **ACL列表接口**：返回包含direction字段的完整规则信息
- **ACL创建接口**：接受direction参数，支持三种方向值
- **ACL编辑接口**：支持修改现有规则的方向
- **批量操作接口**：批量创建时包含direction参数
- **参数验证**：确保direction值只能是'inbound'、'outbound'或'both'

### 3. 同步逻辑修改
- **iptables规则生成**：根据direction值生成不同的防火墙规则
  - `inbound`：生成入口方向规则 (`-i iface -o wg0`)
  - `outbound`：生成出口方向规则 (`-i wg0 -o iface`)
  - `both`：生成双向规则（分别生成入口和出口规则）
- **规则优化**：避免重复规则，提高iptables性能

### 4. 前端界面修改
- **表格显示**：添加方向列，显示规则的方向类型
- **表单控件**：添加方向选择下拉框
- **表单验证**：确保方向字段必填
- **用户体验**：提供方向选择的详细说明和提示

### 5. 测试验证
- 创建专门的测试脚本验证方向控制功能
- 测试不同方向规则的创建、编辑和删除
- 验证iptables规则生成的正确性
- 确保与现有功能的兼容性

## 技术特点

### 灵活性
- ✅ **精细控制**：支持按方向精确控制网络流量
- ✅ **组合使用**：可以为同一目标创建不同方向的规则
- ✅ **全局支持**：全局规则同样支持方向控制

### 兼容性
- ✅ **向后兼容**：现有规则自动设为双向，不影响现有功能
- ✅ **渐进部署**：可以逐步为规则添加方向控制
- ✅ **数据完整性**：通过应用层验证确保数据正确性

### 易用性
- ✅ **直观界面**：清晰的方向选择和显示
- ✅ **详细提示**：为用户提供方向选择的指导
- ✅ **实时同步**：规则修改立即同步到防火墙

## 使用方法

### 创建方向控制规则
1. 进入ACL管理页面
2. 点击"添加防火墙规则"
3. 选择节点（或选择全局规则）
4. 填写目标地址、端口、协议
5. **选择方向**：
   - 入口方向：控制外部访问WireGuard网络
   - 出口方向：控制WireGuard网络访问外部
   - 双向：同时控制进出流量
6. 选择动作（允许/拒绝）
7. 创建规则

### 应用场景

#### 1. 入口安全控制
```bash
# 禁止外部访问WireGuard网络的SSH端口
全局规则 -> 拒绝 0.0.0.0/0:22 (TCP) -> 入口方向
```

#### 2. 出口访问控制
```bash
# 允许WireGuard节点访问公司内网
节点规则 -> 允许 192.168.1.0/24:* (*) -> 出口方向
```

#### 3. 双向隔离
```bash
# 禁止特定网段的双向通信
全局规则 -> 拒绝 10.0.0.0/8:* (*) -> 双向
```

#### 4. 精细权限管理
```bash
# 允许外部访问Web服务，但禁止WireGuard节点访问外部Web
入口规则 -> 允许 0.0.0.0/0:80 (TCP)
出口规则 -> 拒绝 0.0.0.0/0:80 (TCP)
```

## iptables规则示例

### 入口方向规则
```bash
# 允许外部访问WireGuard节点的80端口
iptables -A WG_ACL -d 10.0.0.100 -s 192.168.1.0/24 -i eth0 -o wg0 -p tcp --dport 80 -j ACCEPT
```

### 出口方向规则
```bash
# 允许WireGuard节点访问外部的443端口
iptables -A WG_ACL -s 10.0.0.100 -d 0.0.0.0/0 -i wg0 -o eth0 -p tcp --dport 443 -j ACCEPT
```

### 双向规则
```bash
# 同时生成入口和出口两条规则
iptables -A WG_ACL -d 10.0.0.100 -s 192.168.1.0/24 -i eth0 -o wg0 -j ACCEPT
iptables -A WG_ACL -s 10.0.0.100 -d 192.168.1.0/24 -i wg0 -o eth0 -j ACCEPT
```

## 验证结果
✅ 数据库迁移成功
✅ 功能测试通过
✅ API接口测试通过
✅ 前端界面测试通过
✅ iptables规则生成正确

## 总结
成功实现了ACL方向控制功能，为用户提供了更精细的网络流量管理能力。通过区分入口、出口和双向流量，用户可以实现更复杂的网络安全策略和访问控制需求。
