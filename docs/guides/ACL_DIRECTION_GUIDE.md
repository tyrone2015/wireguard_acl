# ACL 方向控制使用指南

## 功能简介
WireGuard ACL 方向控制功能允许您为防火墙规则指定流量方向，实现更精细的网络访问控制。

## 方向类型

### 1. 入口方向 (Inbound)
- **含义**：控制从外部网络进入WireGuard网络的流量
- **应用场景**：允许外部用户访问WireGuard网络内的服务
- **iptables规则示例**：
  ```bash
  iptables -A WG_ACL -d 10.0.0.100 -s 192.168.1.0/24 -i eth0 -o wg0 -p tcp --dport 80 -j ACCEPT
  ```

### 2. 出口方向 (Outbound)
- **含义**：控制从WireGuard网络出去的流量
- **应用场景**：允许WireGuard节点访问外部网络服务
- **iptables规则示例**：
  ```bash
  iptables -A WG_ACL -s 10.0.0.100 -d 8.8.8.8/32 -i wg0 -o eth0 -p udp --dport 53 -j ACCEPT
  ```

### 3. 双向 (Both)
- **含义**：同时控制入口和出口两个方向的流量
- **应用场景**：完全隔离或允许特定网段的双向通信
- **iptables规则示例**：
  ```bash
  # 入口规则
  iptables -A WG_ACL -d 10.0.0.100 -s 192.168.1.0/24 -i eth0 -o wg0 -j ACCEPT
  # 出口规则
  iptables -A WG_ACL -s 10.0.0.100 -d 192.168.1.0/24 -i wg0 -o eth0 -j ACCEPT
  ```

## 使用示例

### 示例1：Web服务器访问控制
```
目标：允许外部用户访问公司Web服务器，但禁止服务器访问外部Web
规则配置：
1. 入口规则：允许 0.0.0.0/0:80 (TCP) -> 入口方向
2. 出口规则：拒绝 0.0.0.0/0:80 (TCP) -> 出口方向
```

### 示例2：DNS服务访问
```
目标：允许WireGuard节点使用外部DNS服务
规则配置：
全局规则：允许 8.8.8.8/32:53 (UDP) -> 出口方向
```

### 示例3：网络隔离
```
目标：禁止所有节点与危险网段通信
规则配置：
全局规则：拒绝 10.0.0.0/8:* (*) -> 双向
```

### 示例4：精细权限控制
```
目标：开发环境网络策略
规则配置：
1. 允许访问公司内网：允许 192.168.0.0/16:* (*) -> 双向
2. 允许访问Git服务：允许 github.com:443 (TCP) -> 出口方向
3. 禁止访问娱乐网站：拒绝 *.youtube.com:* (*) -> 出口方向
```

## 前端界面操作

1. **进入ACL管理页面**
2. **点击"添加防火墙规则"**
3. **选择节点**：特定节点或全局规则
4. **填写基本信息**：目标IP、端口、协议
5. **选择方向**：
   - 入口方向：控制外部访问内部
   - 出口方向：控制内部访问外部
   - 双向：同时控制两个方向
6. **选择动作**：允许或拒绝
7. **创建规则**

## 注意事项

- **方向选择很重要**：错误的 directions 可能导致意外的网络行为
- **结合使用**：可以为同一目标创建不同方向的规则
- **优先级**：节点特定规则优先于全局规则
- **测试验证**：创建规则后建议测试网络连通性
- **监控日志**：注意WireGuard和iptables的日志信息

## 故障排除

### 规则不生效
1. 检查方向设置是否正确
2. 确认规则已启用
3. 检查iptables规则是否正确生成
4. 验证WireGuard配置是否已重载

### 网络连接问题
1. 检查是否有冲突的规则
2. 确认方向设置符合预期
3. 查看系统日志了解详细错误信息

## 最佳实践

1. **使用全局规则**进行基础安全策略
2. **使用节点特定规则**进行精细权限控制
3. **定期审查**规则的有效性和必要性
4. **测试变更**在生产环境应用前进行充分测试
5. **记录变更**在活动日志中记录规则变更原因
