# 全局ACL规则使用指南

## 功能简介
WireGuard ACL 全局规则功能允许您创建不绑定特定节点的防火墙规则，实现对整个WireGuard网络的统一安全策略。

## 全局规则特性

### 1. 适用范围
- **全局规则**：适用于所有WireGuard节点
- **节点特定规则**：仅适用于指定的节点
- **优先级**：节点特定规则优先于全局规则

### 2. 应用场景

#### 场景1：基础安全策略
```
目标：为所有节点设置基础安全规则
全局规则示例：
- 拒绝所有外部SSH访问：拒绝 0.0.0.0/0:22 (TCP) -> 入口方向
- 允许DNS查询：允许 8.8.8.8/32:53 (UDP) -> 出口方向
- 允许NTP同步：允许 0.0.0.0/0:123 (UDP) -> 出口方向
```

#### 场景2：网络隔离
```
目标：隔离危险网段
全局规则示例：
- 禁止访问已知恶意IP：拒绝 192.168.0.0/16:* (*) -> 双向
- 禁止访问Tor网络：拒绝 0.0.0.0/0:* (*) -> 出口方向 (通过域名解析)
```

#### 场景3：服务访问控制
```
目标：统一管理服务访问权限
全局规则示例：
- 允许访问公司内网：允许 10.0.0.0/8:* (*) -> 双向
- 允许访问Git仓库：允许 github.com:443 (TCP) -> 出口方向
- 允许访问Docker仓库：允许 registry.hub.docker.com:443 (TCP) -> 出口方向
```

## 使用方法

### 前端界面操作

1. **进入ACL管理页面**
2. **点击"添加防火墙规则"**
3. **选择节点**：选择"全局规则"选项
4. **填写规则信息**：
   - 目标IP/域名
   - 端口范围
   - 协议类型
   - 方向（入口/出口/双向）
   - 动作（允许/拒绝）
5. **创建规则**

### API接口使用

#### 创建全局规则
```bash
curl -X POST http://localhost:8000/api/acls \
  -H "Content-Type: application/json" \
  -d '{
    "peer_id": -1,
    "target_ip": "192.168.1.0/24",
    "port": "80",
    "protocol": "tcp",
    "direction": "inbound",
    "action": "allow",
    "description": "允许外部访问Web服务"
  }'
```

#### 查询全局规则
```bash
curl http://localhost:8000/api/acls/global
```

## 规则管理

### 1. 查看全局规则
- 在ACL列表中，全局规则会显示为"全局规则"
- 可以按方向、协议、动作等条件筛选

### 2. 编辑全局规则
- 选择要编辑的全局规则
- 修改规则参数
- 保存变更

### 3. 删除全局规则
- 选择要删除的全局规则
- 确认删除操作

### 4. 批量操作
- 支持批量启用/禁用全局规则
- 支持批量删除全局规则

## 规则冲突处理

### 1. 优先级规则
```
节点特定规则 > 全局规则
```

### 2. 冲突示例
```
全局规则：允许 192.168.1.0/24:* (*) -> 双向
节点A规则：拒绝 192.168.1.100:* (*) -> 双向

结果：节点A无法访问192.168.1.100，但可以访问192.168.1.0/24中的其他IP
```

### 3. 最佳实践
- 全局规则用于设置基础策略
- 节点特定规则用于特殊权限
- 定期审查规则冲突

## 监控与日志

### 1. 规则生效监控
- 查看iptables规则生成情况
- 监控WireGuard日志
- 检查网络连通性

### 2. 活动日志
- 记录全局规则的创建、修改、删除操作
- 记录规则生效时间和操作人

## 故障排除

### 规则不生效
1. 确认规则已启用
2. 检查iptables规则是否正确生成
3. 验证WireGuard配置是否已重载
4. 检查是否有更高优先级的冲突规则

### 性能问题
1. 全局规则过多可能影响性能
2. 建议定期清理无效规则
3. 考虑使用更具体的IP段而非通配符

## 最佳实践

### 1. 规则设计原则
- **最小权限原则**：只开放必要的访问权限
- **明确方向**：根据实际需求选择正确的方向
- **分层管理**：全局规则 + 节点规则结合使用

### 2. 维护建议
- **定期审查**：每月检查全局规则的有效性
- **文档记录**：记录每条规则的目的和创建原因
- **测试验证**：重要变更前进行充分测试
- **备份策略**：定期备份ACL配置

### 3. 安全建议
- **防御优先**：优先创建拒绝规则，然后添加允许规则
- **日志监控**：启用详细日志记录异常访问
- **定期更新**：根据威胁情报更新规则
- **权限控制**：限制ACL规则的修改权限

## 高级用法

### 1. 与方向控制结合
```
全局入口规则：拒绝 0.0.0.0/0:* (*) -> 入口方向
全局出口规则：允许 8.8.8.8/32:53 (UDP) -> 出口方向
节点特定规则：允许 192.168.1.100:80 (TCP) -> 入口方向
```

### 2. 时间-based规则
```
结合系统时间控制规则生效
- 工作时间：允许访问办公网络
- 非工作时间：仅允许基础服务访问
```

### 3. 动态规则更新
```
通过API接口实现自动化规则更新
- 根据安全事件自动调整规则
- 基于流量分析优化规则
```
